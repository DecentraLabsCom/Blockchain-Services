# Docker Compose configuration for Blockchain Services
# 
# Quick Start:
# 1. Generate RSA keys (see README.md)
# 2. Copy .env.example -> .env (gitignored) with default values
# 3. Run: docker-compose up -d
# 4. Open /wallet-dashboard and create/import the institutional wallet.
#    The service auto-stores the encrypted key + credentials (no restart needed).
#
# Note: If deploying behind a reverse proxy (e.g., OpenResty), 
#       comment out the ports mapping to avoid conflicts.

version: '3.8'

services:
  blockchain-services:
    build: .
    image: blockchain-services:latest
    container_name: blockchain-services
    
    # Loads environment configuration from your local .env (gitignored).
    env_file:
      - .env
    
    # Additional environment variables (optional)
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - JAVA_OPTS=-Xmx512m -Xms256m
      # Enable wallet persistence (REQUIRED for institutional wallet to work)
      - WALLET_PERSISTENCE_ENABLED=true
      # Path to wallet storage file (mounted as volume below)
      - WALLET_FILE_PATH=/app/data/wallets.json
    
    # Mount volumes for keys, logs, and wallet data
    # SECURITY: Ensure key files have proper permissions (chmod 400 for private key)
    volumes:
      - ./keys:/app/config/keys:ro
      - ./logs:/app/logs
      # Persistent storage for encrypted wallets (survives container restart)
      - wallet-data:/app/data
    
    # Expose container port for internal networks; host mapping handled via override
    expose:
      - "8080"
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volume for wallet persistence
volumes:
  wallet-data:
    driver: local
    # Optional: Use bind mount for easier backup
    # driver_opts:
    #   type: none
    #   device: /opt/blockchain-services/data
    #   o: bind

# Optional: Add Redis for distributed deployments with multiple instances
#  redis:
#    image: redis:7-alpine
#    container_name: blockchain-redis
#    ports:
#      - "6379:6379"
#    volumes:
#      - redis-data:/data
#    restart: unless-stopped
#    command: redis-server --appendonly yes
#
#volumes:
#  redis-data:
#    driver: local
