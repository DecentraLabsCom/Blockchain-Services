<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DecentraLabs - Treasury Admin Dashboard</title>
    <link rel="icon" type="image/x-icon" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/admin.css">
</head>
<body>
    <!-- Welcome Modal -->
    <div id="welcomeModal" class="welcome-modal">
        <div class="welcome-modal-content">
            <div class="welcome-modal-header">
                <h1><i class="fas fa-rocket"></i> Welcome to DecentraLabs</h1>
            </div>
            <div class="welcome-modal-body">
                <div class="welcome-message">
                    <p><strong>Institutional wallet configured.</strong></p>
                    <p>Next, apply your <strong>provisioning token</strong> from the marketplace.</p>
                    <p>If you do not have one yet, request access for your institution.</p>
                </div>
                <div class="welcome-actions">
                    <a id="marketplaceLink" href="https://marketplace-decentralabs.vercel.app/" target="_blank" rel="noopener noreferrer" class="btn-marketplace">
                        <i class="fas fa-store"></i>
                        Get Provisioning Token from Marketplace
                    </a>
                    <button id="continueBtn" class="btn-continue">
                        <i class="fas fa-check-circle"></i>
                        I Already Have a Token, Let Me In
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Provisioning Token Modal -->
    <div id="provisioningTokenModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-ticket-alt"></i> Apply Provisioning Token</h2>
                <button class="modal-close" id="closeProvisioningModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <p class="info-text">
                    Paste the provisioning token provided by the DecentraLabs marketplace to register your institution on-chain.
                    Supports both <strong>Provider</strong> (publishes labs) and <strong>Consumer</strong> (only reserves labs) tokens.
                </p>
                <textarea id="provisioningTokenInput" class="token-input" rows="5"
                    placeholder="Paste your provisioning token here..."></textarea>
                <div id="provisioningResult" class="invite-result"></div>
            </div>
            <div class="modal-footer">
                <button id="applyProvisioningBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i>
                    Apply Token
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1 class="logo">
                    <a class="logo-link" href="/">
                        <img src="assets/images/logo.svg" alt="DecentraLabs" class="logo-icon-img">
                        DecentraLabs Treasury
                    </a>
                </h1>
                <div class="header-actions">
                    <button id="applyProvisioningTokenHeaderBtn" class="btn btn-primary hidden">
                        <i class="fas fa-ticket-alt"></i> 
                        Use Token
                    </button>
                    <button id="refreshBtn" class="btn btn-success btn-icon" type="button" title="Refresh dashboard">
                        <i class="fas fa-rotate-right"></i>
                    </button>
                    <button id="revealPrivateKeyBtn" class="btn btn-secondary hidden">
                        <i class="fas fa-key"></i> 
                        Wallet Keys
                    </button>
                    <div class="status-indicator" id="statusIndicator">
                        <span class="status-dot"></span>
                        <span class="status-text">Connected</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- System Status Section -->
            <section class="card">
                <div class="card-header">
                    <h2>System Status</h2>
                    <span class="timestamp" id="lastUpdate">Last update: --</span>
                </div>
                <div class="card-body">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Institutional Wallet</span>
                            <span class="info-value" id="walletAddress">Loading...</span>
                            <!-- Wallet Setup Dropdown (shown when not configured) -->
                            <div class="wallet-setup-dropdown hidden" id="walletSetupDropdown">
                                <h3>Setup Institutional Wallet</h3>
                                <p class="dropdown-description">Choose an option to configure the institutional wallet:</p>
                                <div class="wallet-setup-options">
                                    <button id="createWalletBtn" class="btn btn-primary btn-block">
                                        <span class="icon">+</span>
                                        Create New Wallet
                                    </button>
                                    <button id="importWalletBtn" class="btn btn-secondary btn-block">
                                        <span class="icon">â†“</span>
                                        Import Existing Wallet
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Contract Address</span>
                            <span class="info-value" id="contractAddress">Loading...</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Active Network</span>
                            <div class="network-buttons-container">
                                <button id="sepoliaBtn" class="network-btn" data-network="sepolia">
                                    Sepolia
                                </button>
                                <button id="mainnetBtn" class="network-btn" data-network="mainnet">
                                    Mainnet
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Wallet Balances Section -->
            <section class="card">
                <div class="card-header">
                    <h2>Wallet Balances</h2>
                </div>
                <div class="card-body">
                    <div class="balance-grid" id="balanceGrid">
                        <!-- Balances will be loaded dynamically -->
                        <div class="balance-item skeleton">
                            <div class="balance-network">Loading...</div>
                            <div class="balance-amount">--</div>
                        </div>
                    </div>
                    <!-- Promotional message container -->
                    <div id="labPromoMessage" class="hidden"></div>
                    
                    <!-- Treasury Actions -->
                    <div class="treasury-actions-form">
                        <div class="treasury-actions-buttons">
                            <button type="button" id="depositBtn" class="btn btn-success">
                                <i class="fas fa-plus-circle"></i> Deposit
                            </button>
                            <button type="button" id="withdrawBtn" class="btn btn-danger">
                                <i class="fas fa-minus-circle"></i> Withdraw
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Lab Payout Collect Section -->
            <section class="card">
                <div class="card-header">
                    <h2>Lab Payout Collect</h2>
                </div>
                <div class="card-body">
                    <div class="collect-panel" id="collectPanel">
                        <div class="collect-grid">
                            <div class="form-group">
                                <label for="collectLabSelect">Select one of your labs</label>
                                <select id="collectLabSelect" class="collect-select" disabled>
                                    <option value="">Loading labs...</option>
                                </select>
                            </div>
                            <div class="collect-metric">
                                <span class="collect-metric-label">Pending Closures</span>
                                <span class="collect-metric-value" id="collectPendingClosures">--</span>
                            </div>
                            <div class="collect-metric">
                                <span class="collect-metric-label">Pending Rewards</span>
                                <span class="collect-metric-value" id="collectPendingTotal">--</span>
                            </div>
                            <div class="collect-metric">
                                <span class="collect-metric-label">Collect Status</span>
                                <span class="collect-status-value" id="collectStatusText">--</span>
                            </div>
                        </div>
                        <div class="collect-actions">
                            <button type="button" id="collectLabBtn" class="btn btn-primary" disabled>
                                <i class="fas fa-coins"></i> Collect
                            </button>
                        </div>
                        <p class="collect-help" id="collectHelpText">
                            Select one of your labs to check pending rewards and run collect.
                        </p>
                    </div>
                </div>
            </section>

            <!-- Treasury Administration Section -->
            <section class="card">
                <div class="card-header">
                    <h2>Treasury Administration</h2>
                    <span class="warning-badge">âš  Localhost Only</span>
                </div>
                
                <!-- Ongoing Period Info Box -->
                <div class="ongoing-period-box">
                    <h3><i class="fas fa-hourglass-half"></i> Ongoing Period</h3>
                    <div class="period-dates-inline">
                        <div class="date-item-inline">
                            <i class="fas fa-calendar-day"></i>
                            <span class="date-label">Start:</span>
                            <span id="periodStartDateTop" class="date-value">--</span>
                        </div>
                        <div class="date-separator">â†’</div>
                        <div class="date-item-inline">
                            <i class="fas fa-calendar-check"></i>
                            <span class="date-label">End:</span>
                            <span id="periodEndDateTop" class="date-value">--</span>
                        </div>
                    </div>
                </div>
                
                <div class="card-body">
                    <div class="operations-grid">
                        <!-- User Spending Limit Card -->
                        <div class="operation-card">
                            <h3><i class="fas fa-user-check"></i> User Spending Limit</h3>
                            <div class="current-value-display">
                                <span class="label">Current Limit:</span>
                                <span class="value" id="currentUserLimit">--</span>
                            </div>
                            <form id="limitsForm" class="operation-form">
                                <div class="form-group">
                                    <label>New Limit (LAB Tokens)</label>
                                    <input type="text" id="userLimitInput" placeholder="e.g., 1000">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Update Limit
                                </button>
                            </form>
                        </div>

                        <!-- Spending Period Card -->
                        <div class="operation-card">
                            <h3><i class="fas fa-calendar-alt"></i> Spending Period</h3>
                            <div class="current-value-display">
                                <span class="label">Current Period:</span>
                                <span class="value" id="currentPeriod">--</span>
                            </div>
                            <form id="periodForm" class="operation-form">
                                <div class="form-group">
                                    <label>Period Duration (days)</label>
                                    <input type="text" id="periodInput" placeholder="e.g., 30">
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-edit"></i> Update Period
                                </button>
                            </form>
                        </div>

                        <!-- Reset Period Card -->
                        <div class="operation-card">
                            <h3><i class="fas fa-redo-alt"></i> Reset Period</h3>
                            <p class="operation-description">
                                Reset the spending period counters. All users' spending will be reset to zero and a new period will begin immediately.
                            </p>
                            <button id="resetPeriodBtn" class="btn btn-warning full-width">
                                <i class="fas fa-sync-alt"></i> Reset Spending Period
                            </button>
                        </div>
                    </div>
                    
                    <!-- Top Spenders Section -->
                    <div class="top-spenders-section">
                        <button id="showTopSpendersBtn" class="btn btn-secondary full-width">
                            <i class="fas fa-chart-line"></i> View Top 10 Spenders
                        </button>
                    </div>
                </div>
            </section>

            <!-- Recent Transactions Section -->
            <section class="card">
                <div class="card-header">
                    <h2>Recent Transactions</h2>
                </div>
                <div class="card-body">
                    <div class="transactions-container" id="transactionsContainer">
                        <div class="no-data">
                            <span class="icon">ðŸ“‹</span>
                            <p>Transaction history tracking not yet implemented</p>
                            <small>Consider integrating Etherscan API or event indexing</small>
                        </div>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="dashboard-footer">
            <div class="footer-content">
                <div class="footer-logo">
                    <img src="assets/images/LogoBannerDLabs.png" alt="DecentraLabs" class="footer-logo-img">
                </div>
                <div class="footer-text">
                    <p>&copy; 2025 DecentraLabs. Institutional Treasury Administration Dashboard</p>
                    <p class="security-notice">ðŸ”’ This dashboard is only accessible internally for security</p>
                </div>
                <div class="footer-logo">
                    <img src="assets/images/LogoBannerNebsyst.png" alt="Nebulous Systems" class="footer-logo-img">
                </div>
            </div>
        </footer>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    <!-- Input Modal (for prompts) -->
    <div id="inputModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="inputModalTitle"><i class="fas fa-keyboard"></i> Input Required</h2>
                <button type="button" class="modal-close" id="closeInputModal" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="inputModalMessage"></p>
                <input type="password" id="inputModalField" class="modal-input" placeholder="Enter value...">
                <div class="modal-actions">
                    <button id="inputModalConfirm" class="btn btn-primary">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button id="inputModalCancel" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="confirmModalTitle"><i class="fas fa-question-circle"></i> Confirm Action</h2>
                <button type="button" class="modal-close" id="closeConfirmModal" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" class="confirm-message"></p>
                <div class="modal-actions">
                    <button id="confirmModalConfirm" class="btn btn-primary">
                        <i class="fas fa-check"></i> Confirm
                    </button>
                    <button id="confirmModalCancel" class="btn btn-secondary">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Modal (for alerts/results) -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="infoModalTitle"><i class="fas fa-check-circle"></i> Success</h2>
                <button type="button" class="modal-close" id="closeInfoModal" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="infoModalContent"></div>
                <div class="modal-actions">
                    <button id="infoModalClose" class="btn btn-primary">
                        <i class="fas fa-check"></i> OK
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Spenders Modal -->
    <div id="topSpendersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trophy"></i> Top 10 Spenders - Current Period</h2>
                <button type="button" class="modal-close" id="closeTopSpendersModal" title="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="topSpendersContainer">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Loading spenders data...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/auth-token-fetch.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/admin.js"></script>
</body>
</html>
